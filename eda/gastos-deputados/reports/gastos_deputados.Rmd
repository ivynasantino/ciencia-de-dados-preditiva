---
title: "Análise de gastos dos deputados"
author: "Ivyna Santino"
date: "29 de agosto de 2018"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
  html_notebook:
    toc: yes
    toc_float: yes
---
```{r setup, include=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(plotly)
theme_set(theme_minimal())
```

Introdução: o que é o checkpoint e que dados iremos trabalhar.

Para iniciarmos nossa análise, o primeiro passo é importar nossos dados.

```{r, message=FALSE, warning=FALSE, include=FALSE}
dadosCEAP = read_csv(here("data/dadosCEAP.csv"))
limiteCEAP = read_csv(here("data/limiteMensalCEAP.csv"))
```

Dados fornecidos:
  
  - nomeParlamentar: Nome adotado pelo Parlamentar ao tomar posse do seu mandato.
  - idCadastro: Número que identifica unicamente um deputado federal na CD.
  - sgUF: No contexto da cota CEAP, representa a unidade da federação pela qual o deputado foi eleito e é utilizada para definir o valor da cota a que o deputado tem.
  - sgPartido: Sigla do partido do parlamentar.
  - tipoDespesa: O seu conteúdo é a descrição do Tipo de Despesa relativo à despesa em questão.
  - especDespesa: Representa a descrição  especificação mais detalhada de um referido Tipo de Despesa.
  - fornecedor: O conteúdo deste dado representa o nome do fornecedor do produto ou serviço presente no documento fiscal
  - CNPJCPF: O conteúdo deste dado representa o CNPJ ou o CPF do emitente do documento fiscal, quando se tratar do uso da cota em razão do reembolso despesas comprovadas pela emissão de documentos fiscais.
  - tipoDocumento: Este dado representa o tipo de documento do fiscal – 0 (Zero), para Nota Fiscal; 1 (um), para Recibo; e 2, para Despesa no Exterior.
  - dataEmissao: O conteúdo deste dado é a data de emissão do documento fiscal ou a data do documento que tenha dado causa à despesa.
  - valorDocumento: O seu conteúdo é o valor de face do documento fiscal ou o valor do documento que deu causa à despesa. Quando se tratar de bilhete aéreo, esse valor poderá ser negativo, significando que o referido bilhete é um bilhete de compensação, pois compensa um outro bilhete emitido e não utilizado pelo deputado (idem para o dado vlrLiquido abaixo).
  - valorGlosa: O seu conteúdo representa o valor da glosa do documento fiscal que incidirá sobre o Valor do Documento, ou o valor da glosa do documento que deu causa à despesa.
  - valorLiquido: O seu conteúdo representa o valor líquido do documento fiscal ou do documento que deu causa à despesa e será calculado pela diferença entre o Valor do Documento e o Valor da Glosa. É este valor que será debitado da cota do deputado. Caso o débito seja do Tipo Telefonia e o valor seja igual a zero, significa que a despesa foi franqueada.

```{r, message=FALSE, warning=FALSE, include=FALSE}
dadosCEAP$valorGlosa <- as.numeric(sub(",", ".", dadosCEAP$valorGlosa, fixed = TRUE)) 
```

### Quais os deputados que mais gastaram dinheiro da CEAP?

```{r, message=FALSE}
dadosCEAP %>% 
  group_by(nomeParlamentar) %>% 
  summarise(valorTot = sum(valorLíquido)) %>%
  filter(valorTot >= 0) %>% 
  arrange(-valorTot) %>% 
  slice(1:10) %>% 
  na.omit(.) %>% 
  ggplot(aes(x = reorder(nomeParlamentar, valorTot),
             y = valorTot,
             fill = valorTot)) +
  geom_col(position = position_identity()) +
  labs(y = "Valor gasto total",
       x = "Nome do candidato",
       title = "Top 10 dos candidatos mais gastosos") +
  coord_flip()
```

### Quais os mais ecoômicos?
```{r, message=FALSE}
dadosCEAP %>% 
  group_by(nomeParlamentar) %>% 
  summarise(valorTot = sum(valorLíquido)) %>%
  filter(valorTot >= 0) %>% 
  arrange(valorTot) %>% 
  slice(1:10) %>% 
  na.omit(.) %>% 
  ggplot(aes(x = reorder(nomeParlamentar, -valorTot),
             y = valorTot,
             fill = valorTot)) +
  geom_col(position = position_identity()) +
  labs(y = "Valor gasto total",
       x = "Nome do candidato",
       title = "Top 10 dos candidatos mais econômicos") +
  coord_flip()
```


### Quais os estados cujos deputados gastam mais e menos no exterior?

```{r, message=FALSE}
dadosCEAP %>% 
  filter(tipoDocumento == 2) %>% 
  group_by(sgUF) %>% 
  summarise(valorTot = sum(valorLíquido)) %>%
  arrange(-valorTot) %>% 
  na.omit(.) %>% 
  ggplot(aes(x = reorder(sgUF, -valorTot),
             y = valorTot,
             color = sgUF)) +
  geom_point() +
  geom_segment(aes(x = reorder(sgUF, -valorTot),
                   xend = reorder(sgUF, -valorTot),
                   y = 0,
                   yend = valorTot)) +
  labs(x = "UF",
       y = "Valor gasto (R$)",
       title = "Gastos de cada estado no exterior")
  
```

### Quais os partidos cujos parlamentares mais usam CEAP no estado da Paraíba? E os que menos usam?


```{r, message=FALSE}
dadosCEAP %>% 
  filter(sgUF == "PB") %>% 
  group_by(sgPartido) %>% 
  summarise(valorCEAP = sum(valorLíquido),
            countGastos = n()) %>% 
  plot_ly(x = ~sgPartido,
          y = ~countGastos,
          color = ~valorCEAP,
          type = 'bar',
          text = ~paste('Sigla do partido: ', sgPartido,
                        '<br>Quantidade de gastos: ', countGastos,
                        '<br>Valor gasto CEAP: R$', valorCEAP)) %>% 
    layout(title = "Partidos que mais usam o CEAP na PB",
           xaxis = list(title = "Partido"),
           yaxis = list(title = "Quantidade de gastos"))

  
```

### Quais os deputados que mais ultrapassam o limite de CEAP do seu estado? 

```{r, message=FALSE}
limitePB <- limiteCEAP %>% 
  filter(UF == "PB")

dadosCEAP %>% 
  filter(sgUF == "PB") %>% 
  group_by(nomeParlamentar) %>% 
  summarise(valorTot = sum(valorLíquido)) %>% 
  filter(valorTot > limitePB$limite_mensal) %>% 
  slice(1:10) %>% 
  na.omit(.) %>% 
  ggplot(aes(x = reorder(nomeParlamentar, -valorTot),
             y = valorTot)) +
  geom_point() +
  coord_flip() +
  labs(title = "Top 10 dos deputados que ultrapassaram o limite de CEAP na PB",
       y = "Valor em (R$)",
       x = "Nome do deputado")

```

### Quais estados cujos parlamentares gastam mais com passagens aéreas?

```{r, message=FALSE}
dadosCEAP %>% 
  filter(tipoDespesa == "PASSAGENS AÉREAS") %>% 
  group_by(sgUF) %>% 
  summarise(valorTot = sum(valorLíquido)) %>% 
  na.omit(.) %>% 
  ggplot(aes(x = reorder(sgUF, -valorTot),
             y = valorTot,
             color = sgUF)) +
  geom_point() +
  geom_segment(aes(x = reorder(sgUF, -valorTot),
                   xend = reorder(sgUF, -valorTot),
                   y = 0,
                   yend = valorTot)) +
  coord_flip() +
  labs(x = "UF",
       y = "Valor gasto (R$)",
       title = "Gasto de passagens aéreas por estado com parlamentares")

```

```{r, message=FALSE, include=FALSE}
# Extraindo dados dos partidos escolhidos: PMDB - PSDB - PT
dadosPMDB <- dadosCEAP %>% 
  filter(sgPartido == "PMDB")

dadosPSDB <- dadosCEAP %>% 
  filter(sgPartido == "PSDB")

dadosPT <- dadosCEAP %>% 
  filter(sgPartido == "PT")
```

### Quais são os tipos de despesa mais utilizados no uso da CEAP pelos deputados desses partidos?

```{r, message=FALSE}

dadosPMDB %>% 
  group_by(tipoDespesa) %>% 
  summarise(valor_total = sum(valorLíquido)) %>% 
  na.omit(.) %>% 
  plot_ly(x = ~valor_total,
          y = ~tipoDespesa,
          type = 'bar',
          color = ~valor_total,
          text = ~paste('Valor total: R$', valor_total,
                        '<br>Tipo de despesa: ', tipoDespesa)) %>% 
  layout(title = "Tipos de despesas: PMDB",
           xaxis = list(title = "Valor total (R$)"),
           yaxis = list(title = "Tipo de despesa"))

```


```{r, message=FALSE}

dadosPSDB %>% 
  group_by(tipoDespesa) %>% 
  summarise(valor_total = sum(valorLíquido)) %>% 
  na.omit(.) %>% 
  plot_ly(x = ~valor_total,
          y = ~tipoDespesa,
          type = 'bar',
          color = ~valor_total,
          text = ~paste('Valor total: R$', valor_total,
                        '<br>Tipo de despesa: ', tipoDespesa)) %>% 
  layout(title = "Tipos de despesas: PSDB",
           xaxis = list(title = "Valor total (R$)"),
           yaxis = list(title = "Tipo de despesa"))


```


```{r, message=FALSE, warning=FALSE}
dadosPT %>% 
  group_by(tipoDespesa) %>% 
  summarise(valor_total = sum(valorLíquido)) %>% 
  na.omit(.) %>% 
  plot_ly(x = ~valor_total,
          y = ~tipoDespesa,
          type = 'bar',
          color = ~valor_total,
          text = ~paste('Valor total: R$', valor_total,
                        '<br>Tipo de despesa: ', tipoDespesa)) %>% 
  layout(title = "Tipos de despesas: PT",
           xaxis = list(title = "Valor total (R$)"),
           yaxis = list(title = "Tipo de despesa"))

```



Conclusão do lab.
